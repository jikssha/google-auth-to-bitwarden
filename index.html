<!DOCTYPE html>
<html lang="zh-CN" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authenticator Pro | è°·æ­ŒéªŒè¯å™¨è½¬æ¢å·¥å…·</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/protobufjs@7.2.5/dist/protobuf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hi-base32@0.5.1/build/base32.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/otpauth/9.1.4/otpauth.umd.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        vercel: { blue: '#0070f3', error: '#ee0000' },
                        gray: { 100: '#eaeaea', 800: '#333333', 900: '#111111', 950: '#000000' }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-feature-settings: "rlig" 1, "calt" 1; }
        .bg-dots {
            background-image: radial-gradient(#d4d4d4 1px, transparent 1px);
            background-size: 24px 24px;
        }
        .dark .bg-dots { background-image: radial-gradient(#333 1px, transparent 1px); }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        .dark .glass { background: rgba(0, 0, 0, 0.8); }
        .transition-vercel { transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
    </style>
</head>
<body class="bg-white dark:bg-black text-black dark:text-white min-h-screen flex flex-col transition-colors duration-300 font-sans tracking-tight">

    <div class="fixed inset-0 pointer-events-none z-0 bg-dots opacity-40 [mask-image:radial-gradient(ellipse_at_center,black,transparent_80%)]"></div>

    <header class="sticky top-0 z-50 border-b border-gray-100 dark:border-gray-800 glass">
        <div class="container mx-auto px-6 max-w-5xl h-16 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-3">
                    <svg class="w-6 h-6 text-black dark:text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L22 19H2L12 2Z"></path></svg>
                    <span class="font-bold text-lg tracking-tighter">Authenticator<span class="text-gray-400 font-normal ml-1">Pro</span></span>
                </div>
                <span class="text-gray-200 dark:text-gray-800 text-xl font-light">/</span>
                <div class="flex items-center gap-2">
                    <img id="user-avatar" src="" class="w-5 h-5 rounded-full grayscale opacity-80">
                    <span id="user-name-nav" class="text-sm font-medium text-gray-500"></span>
                </div>
            </div>

            <div class="flex items-center gap-5">
                 <button id="theme-toggle" class="text-gray-400 hover:text-black dark:hover:text-white transition-vercel">
                    <svg id="icon-sun" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg id="icon-moon" class="w-5 h-5 block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
                <a id="github-link" href="#" target="_blank" class="text-gray-400 hover:text-black dark:hover:text-white transition-vercel">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"></path></svg>
                </a>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-6 py-12 max-w-5xl relative z-10">

        <div class="text-center mb-16">
            <h1 class="text-4xl font-extrabold tracking-tighter mb-4 bg-clip-text text-transparent bg-gradient-to-b from-black to-gray-600 dark:from-white dark:to-gray-500 pb-2">
               Authenticatoræœ¬åœ°è½¬æ¢å™¨ 
            </h1>
            <p class="text-gray-500 text-lg max-w-xl mx-auto font-normal">
                å°† Google Authenticator å¯¼å‡ºæ•°æ®å³åˆ»è½¬æ¢ä¸º Bitwarden æ ¼å¼
                <br>æœ¬åœ°å¤„ç† Â· é›¶å»¶è¿Ÿ Â· éšç§å®‰å…¨
            </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
            
            <div id="drop-zone" class="group relative rounded-md border border-gray-100 dark:border-gray-800 bg-white dark:bg-black hover:border-black dark:hover:border-white transition-vercel cursor-pointer h-48 flex flex-col items-center justify-center overflow-hidden shadow-[0_0_0_1px_rgba(0,0,0,0.08)] hover:shadow-[0_0_0_1px_rgba(0,0,0,0.12),0_8px_30px_rgba(0,0,0,0.12)] dark:shadow-none">
                <input type="file" id="file-input" class="hidden" multiple accept="image/*">
                <div class="z-10 text-center space-y-2 group-hover:-translate-y-1 transition-vercel">
                    <div class="mx-auto w-10 h-10 rounded-full bg-gray-50 dark:bg-gray-900 flex items-center justify-center border border-gray-100 dark:border-gray-800">
                        <svg class="w-5 h-5 text-gray-500 group-hover:text-black dark:group-hover:text-white transition-vercel" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    </div>
                    <div>
                        <p class="font-semibold text-sm">æ‰«ææˆªå›¾</p>
                        <p class="text-xs text-gray-400">æ”¯æŒæ‹–æ‹½å¤šä¸ªå›¾ç‰‡æˆ–ç›´æ¥ç²˜è´´ (Ctrl+V)</p>
                    </div>
                </div>
            </div>

            <div id="json-zone" class="group relative rounded-md border border-gray-100 dark:border-gray-800 bg-white dark:bg-black hover:border-vercel-blue transition-vercel cursor-pointer h-48 flex flex-col items-center justify-center overflow-hidden shadow-[0_0_0_1px_rgba(0,0,0,0.08)]">
                <input type="file" id="json-input" class="hidden" accept=".json">
                <div class="z-10 text-center space-y-2 group-hover:-translate-y-1 transition-vercel">
                    <div class="mx-auto w-10 h-10 rounded-full bg-gray-50 dark:bg-gray-900 flex items-center justify-center border border-gray-100 dark:border-gray-800">
                        <svg class="w-5 h-5 text-gray-500 group-hover:text-vercel-blue transition-vercel" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    </div>
                    <div>
                        <p class="font-semibold text-sm">å¯¼å…¥ JSON</p>
                        <p class="text-xs text-gray-400">æŸ¥çœ‹éªŒè¯ç æˆ–éªŒè¯å¤‡ä»½æ–‡ä»¶</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="data-panel" class="hidden">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4">
                <div class="relative w-full md:w-64">
                    <input type="text" id="search-input" placeholder="æœç´¢è´¦æˆ·..." class="w-full h-9 px-3 rounded-md bg-white dark:bg-black border border-gray-100 dark:border-gray-800 text-sm focus:outline-none focus:ring-1 focus:ring-black dark:focus:ring-white transition-vercel placeholder-gray-400">
                </div>
                <div class="flex gap-2 w-full md:w-auto">
                    <button id="clear-btn" class="h-9 px-4 text-xs font-medium rounded-md border border-gray-100 dark:border-gray-800 bg-white dark:bg-black hover:bg-gray-50 dark:hover:bg-gray-900 transition-vercel text-gray-500">é‡ç½®åˆ—è¡¨</button>
                    <button id="export-btn" class="h-9 px-4 text-xs font-medium rounded-md bg-black dark:bg-white text-white dark:text-black hover:opacity-80 transition-vercel shadow-sm">å¯¼å‡º Bitwarden JSON</button>
                </div>
            </div>

            <div class="rounded-md border border-gray-100 dark:border-gray-800 overflow-hidden bg-white dark:bg-black">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-50 dark:bg-gray-900 border-b border-gray-100 dark:border-gray-800">
                        <tr>
                            <th class="px-4 py-3 font-medium text-xs text-gray-500 uppercase tracking-wider">å‘è¡Œæ–¹</th>
                            <th class="px-4 py-3 font-medium text-xs text-gray-500 uppercase tracking-wider">è´¦æˆ·</th>
                            <th class="px-4 py-3 font-medium text-xs text-gray-500 uppercase tracking-wider w-32">éªŒè¯ç </th>
                            <th class="px-4 py-3 font-medium text-xs text-gray-500 uppercase tracking-wider text-right">äºŒç»´ç </th>
                        </tr>
                    </thead>
                    <tbody id="accounts-tbody" class="divide-y divide-gray-100 dark:divide-gray-800"></tbody>
                </table>
                <div id="empty-search" class="hidden py-12 text-center text-gray-400 text-sm italic font-mono">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…é¡¹</div>
            </div>
            
            <div class="mt-2 text-right">
                 <span class="text-[10px] text-gray-400 font-mono tracking-widest uppercase">å…±è®¡: <span id="count-badge" class="font-bold">0</span> é¡¹</span>
            </div>
        </div>

    </main>

    <footer class="border-t border-gray-100 dark:border-gray-800 py-12 bg-gray-50/50 dark:bg-gray-900/30">
        <div class="container mx-auto px-6 max-w-5xl">
            <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                <div class="text-center md:text-left">
                    <p class="text-black dark:text-white text-sm font-semibold mb-1">
                        ç”± <a id="footer-link" href="#" target="_blank" class="hover:text-vercel-blue underline decoration-gray-200 underline-offset-4 transition-vercel"></a> æ„å»º
                    </p>
                    <p class="text-gray-400 text-xs">æœ¬åœ°å¤„ç† Â· é›¶æœåŠ¡å™¨ä¸Šä¼  Â· éšç§ä¼˜å…ˆ</p>
                </div>
                <div class="flex gap-8 items-center">
                    <div class="text-right hidden md:block">
                        <p class="text-[10px] text-gray-300 font-mono uppercase tracking-widest">Security Status</p>
                        <p class="text-xs text-emerald-500 font-medium">â— Client-Side Encrypted</p>
                    </div>
                    <a id="github-link-footer" href="#" target="_blank" class="text-gray-400 hover:text-black dark:hover:text-white transition-vercel">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"></path></svg>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <div id="toast" class="fixed bottom-6 right-6 z-50 transform translate-y-20 opacity-0 transition-all duration-300">
        <div id="toast-body" class="bg-black dark:bg-white text-white dark:text-black px-4 py-3 rounded-md shadow-xl flex items-center gap-3 border border-transparent dark:border-gray-200">
            <p id="toast-msg" class="text-sm font-medium pr-2"></p>
        </div>
    </div>

    <div id="qr-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-white/50 dark:bg-black/50 backdrop-blur-sm hidden opacity-0 transition-vercel">
        <div class="bg-white dark:bg-black rounded-lg border border-gray-100 dark:border-gray-800 p-6 max-w-sm w-full shadow-2xl transform scale-95 transition-vercel">
            <h3 id="qr-modal-title" class="text-base font-bold mb-1"></h3>
            <p id="qr-modal-subtitle" class="text-xs text-gray-400 mb-6 font-mono truncate"></p>
            <div class="flex justify-center bg-white p-2 rounded border border-gray-100 mb-6">
                <canvas id="qr-canvas"></canvas>
            </div>
            <button id="close-modal" class="w-full h-9 bg-gray-50 dark:bg-gray-900 text-xs font-medium rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 transition-vercel">å…³é—­çª—å£</button>
        </div>
    </div>

    <script>
        // ==========================================
        // ğŸ”§ ä¸ªäººä¿¡æ¯é…ç½®
        // ==========================================
        const CONFIG = {
            name: "Daemon", 
            githubUrl: "https://github.com/jikssha", 
            avatarUrl: "https://imphub.pepeth.qzz.io/file/pepe/1763451873884_c601705a-b277-4aef-a0bf-753686adf563.png" 
        };

        // ==========================================
        // ğŸš€ æ ¸å¿ƒé€»è¾‘
        // ==========================================
        const protoDefinition = { nested: { MigrationPayload: { fields: { otpParameters: { rule: "repeated", type: "OtpParameters", id: 1 }, version: { type: "int32", id: 2 }, batchSize: { type: "int32", id: 3 }, batchIndex: { type: "int32", id: 4 }, batchId: { type: "int32", id: 5 } } }, OtpParameters: { fields: { secret: { type: "bytes", id: 1 }, name: { type: "string", id: 2 }, issuer: { type: "string", id: 3 }, algorithm: { type: "Algorithm", id: 4 }, digits: { type: "int32", id: 5 }, type: { type: "OtpType", id: 6 }, counter: { type: "int64", id: 7 } } }, Algorithm: { values: { ALGORITHM_UNSPECIFIED: 0, ALGORITHM_SHA1: 1, ALGORITHM_SHA256: 2, ALGORITHM_SHA512: 3, ALGORITHM_MD5: 4 } }, OtpType: { values: { OTP_TYPE_UNSPECIFIED: 0, OTP_TYPE_HOTP: 1, OTP_TYPE_TOTP: 2 } } } };
        let accounts = [], root = null, searchTerm = "";

        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            applyConfig();
            try { root = protobuf.Root.fromJSON(protoDefinition); } catch (e) { console.error(e); }
            setupEvents();
            setInterval(updateTotpDisplay, 1000);
        });

        function applyConfig() {
            document.getElementById('user-avatar').src = CONFIG.avatarUrl;
            document.getElementById('user-name-nav').textContent = CONFIG.name;
            document.getElementById('footer-link').textContent = CONFIG.name;
            document.getElementById('footer-link').href = CONFIG.githubUrl;
            document.getElementById('github-link').href = CONFIG.githubUrl;
            document.getElementById('github-link-footer').href = CONFIG.githubUrl;
        }

        function initTheme() {
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
            document.getElementById('theme-toggle').onclick = () => {
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            };
        }

        function setupEvents() {
            // æ–‡ä»¶ä¸Šä¼ ä¸æ‹–æ‹½
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');
            dropZone.onclick = () => fileInput.click();
            fileInput.onchange = (e) => processFiles(e.target.files);
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => dropZone.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); }));
            dropZone.addEventListener('dragover', () => dropZone.classList.add('border-black', 'dark:border-white'));
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('border-black', 'dark:border-white'));
            dropZone.addEventListener('drop', (e) => {
                dropZone.classList.remove('border-black', 'dark:border-white');
                processFiles(e.dataTransfer.files);
            });

            // ç²˜è´´æ”¯æŒ
            document.addEventListener('paste', (e) => {
                const items = e.clipboardData.items;
                const files = [];
                for(let i=0; i<items.length; i++) if(items[i].type.indexOf('image')!==-1) files.push(items[i].getAsFile());
                if(files.length) processFiles(files);
            });

            // JSON å¯¼å…¥
            document.getElementById('json-zone').onclick = () => document.getElementById('json-input').click();
            document.getElementById('json-input').onchange = (e) => processJson(e.target.files[0]);

            // æœç´¢ä¸æ§åˆ¶
            document.getElementById('search-input').addEventListener('input', (e) => { searchTerm = e.target.value.toLowerCase(); render(); });
            document.getElementById('clear-btn').onclick = () => { if(confirm('ç¡®å®šè¦æ¸…ç©ºåˆ—è¡¨å—ï¼Ÿ')){ accounts = []; render(); } };
            document.getElementById('export-btn').onclick = exportJson;
            
            // æ¨¡æ€æ¡†
            const modal = document.getElementById('qr-modal');
            document.getElementById('close-modal').onclick = () => {
                modal.classList.remove('opacity-100');
                setTimeout(()=>modal.classList.add('hidden'), 200);
            };
        }

        async function processFiles(files) {
            const imgs = Array.from(files).filter(f => f.type.startsWith('image/'));
            if(!imgs.length) return;
            showToast('æ­£åœ¨è¯†åˆ«ä¸­...', 'loading');
            let count = 0;
            for(const f of imgs) {
                try {
                    const fr = new FileReader();
                    const img = await new Promise(r => { fr.onload=e=>{ const i=new Image(); i.onload=()=>r(i); i.src=e.target.result; }; fr.readAsDataURL(f); });
                    const code = scan(img);
                    if(code?.data.startsWith('otpauth-migration://')) {
                        const newAccs = decode(code.data);
                        newAccs.forEach(a => { if(!accounts.find(x=>x.secret===a.secret)) { accounts.push(a); count++; }});
                    }
                } catch(e) { console.error(e); }
            }
            render();
            showToast(count > 0 ? `æˆåŠŸå¯¼å…¥ ${count} ä¸ªè´¦æˆ·` : 'æœªè¯†åˆ«åˆ°æœ‰æ•ˆäºŒç»´ç ', count > 0 ? 'success' : 'error');
        }

        function processJson(file) {
            if(!file) return;
            const r = new FileReader();
            r.onload = (e) => {
                try {
                    const d = JSON.parse(e.target.result);
                    let c = 0;
                    if(d.items) d.items.forEach(i => {
                        if(i.login?.totp) {
                            let issuer="Unknown", name=i.name;
                            if(i.name.includes(':')) { const p=i.name.split(':'); issuer=p[0].trim(); name=p.slice(1).join(':').trim(); }
                            if(!accounts.find(x=>x.secret===i.login.totp)) {
                                accounts.push({ secret:i.login.totp, name, issuer, type:'TOTP', algorithm:'SHA1', digits:6 });
                                c++;
                            }
                        }
                    });
                    render();
                    showToast(`æˆåŠŸå¯¼å…¥ ${c} ä¸ªè´¦æˆ·`, 'success');
                } catch(e) { showToast('JSON æ ¼å¼æ— æ•ˆ', 'error'); }
            };
            r.readAsText(file);
        }

        function scan(img) {
            const cvs = document.createElement('canvas');
            const ctx = cvs.getContext('2d', { willReadFrequently: true });
            const w=img.width, h=img.height; cvs.width=w; cvs.height=h; ctx.drawImage(img,0,0);
            const d = ctx.getImageData(0,0,w,h);
            let res = jsQR(d.data, w, h); if(res) return res;
            
            const inv = new Uint8ClampedArray(d.data);
            for(let i=0;i<inv.length;i+=4) { inv[i]=255-inv[i]; inv[i+1]=255-inv[i+1]; inv[i+2]=255-inv[i+2]; inv[i+3]=255; }
            res = jsQR(inv, w, h); if(res) return res;

            const cw=Math.floor(w*0.7), ch=Math.floor(h*0.7), cx=(w-cw)/2, cy=(h-ch)/2;
            cvs.width=cw; cvs.height=ch; ctx.drawImage(img,cx,cy,cw,ch,0,0,cw,ch);
            const cd = ctx.getImageData(0,0,cw,ch);
            const cb = new Uint8ClampedArray(cd.data);
            for(let i=0;i<cb.length;i+=4) { const v=(cb[i]+cb[i+1]+cb[i+2])/3 > 128 ? 255:0; cb[i]=cb[i+1]=cb[i+2]=v; cb[i+3]=255; }
            return jsQR(cb, cw, ch);
        }

        function decode(uri) {
            try {
                const u = new URL(uri);
                const buf = protobuf.util.newBuffer(protobuf.util.base64.length(u.searchParams.get('data')));
                protobuf.util.base64.decode(u.searchParams.get('data'), buf, 0);
                const msg = root.lookupType("MigrationPayload").decode(buf);
                return msg.otpParameters.map(p => ({ secret: base32.encode(p.secret).replace(/=/g,''), name:p.name||'', issuer:p.issuer||'', type:'TOTP', algorithm:'SHA1', digits:6 }));
            } catch(e) { return []; }
        }

        function render() {
            const panel = document.getElementById('data-panel');
            const tbody = document.getElementById('accounts-tbody');
            if(accounts.length===0) { panel.classList.add('hidden'); return; }
            panel.classList.remove('hidden');
            const filtered = accounts.filter(a => (a.name+a.issuer).toLowerCase().includes(searchTerm));
            document.getElementById('count-badge').textContent = accounts.length;
            document.getElementById('empty-search').className = filtered.length===0 ? 'block py-12 text-center text-gray-400 text-sm italic' : 'hidden';
            tbody.innerHTML = filtered.map((a) => `
                <tr class="group hover:bg-gray-50 dark:hover:bg-gray-900 transition-vercel">
                    <td class="px-4 py-3 font-semibold text-gray-900 dark:text-gray-100">${escape(a.issuer||'Unknown')}</td>
                    <td class="px-4 py-3 text-gray-500 dark:text-gray-400 font-mono text-xs">${escape(a.name)}</td>
                    <td class="px-4 py-3"><div class="flex items-center gap-2"><span id="code-${a.secret}" class="font-mono text-vercel-blue font-bold tracking-wider">...</span><div class="w-3 h-3 rounded-full border border-gray-100 dark:border-gray-800 relative overflow-hidden"><div id="pie-${a.secret}" class="absolute inset-0 bg-gray-200 dark:bg-gray-700 origin-bottom" style="transform:scaleY(0)"></div></div></div></td>
                    <td class="px-4 py-3 text-right"><button onclick="showQr('${a.secret}')" class="text-gray-300 hover:text-black dark:hover:text-white transition-vercel"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4h2v-4zM6 6h2v2H6V6zm0 8h2v2H6v-2zm8-8h2v2h-2V6zm-8 4h2v2H6v-2zm4-4h2v2h-2V6z"></path></svg></button></td>
                </tr>
            `).join('');
            updateTotpDisplay();
        }

        function updateTotpDisplay() {
            const epoch = Math.floor(Date.now()/1000);
            const rem = 30 - (epoch % 30);
            accounts.forEach(a => {
                const el = document.getElementById(`code-${a.secret}`);
                const pie = document.getElementById(`pie-${a.secret}`);
                if(el && pie) {
                    try {
                        const t = new OTPAuth.TOTP({secret: OTPAuth.Secret.fromBase32(a.secret)});
                        el.textContent = t.generate().replace(/(\d{3})(\d{3})/, '$1 $2');
                        pie.style.transform = `scaleY(${rem/30})`;
                        pie.className = `absolute inset-0 origin-bottom transition-vercel ${rem<5 ? 'bg-vercel-error' : 'bg-gray-300 dark:bg-gray-500'}`;
                    } catch(e){}
                }
            });
        }

        function showQr(secret) {
            const acc = accounts.find(a=>a.secret===secret);
            if(!acc) return;
            const modal = document.getElementById('qr-modal');
            document.getElementById('qr-modal-title').textContent = acc.issuer;
            document.getElementById('qr-modal-subtitle').textContent = acc.name;
            const uri = `otpauth://totp/${encodeURIComponent(acc.issuer)}:${encodeURIComponent(acc.name)}?secret=${acc.secret}&issuer=${encodeURIComponent(acc.issuer)}`;
            QRCode.toCanvas(document.getElementById('qr-canvas'), uri, {width:200, margin:0}, ()=>{
                modal.classList.remove('hidden');
                setTimeout(()=>modal.classList.add('opacity-100'),10);
            });
        }

        function exportJson() {
            const data = { encrypted:false, folders:[], items: accounts.map(a => ({ type:1, name:`${a.issuer}: ${a.name}`, login:{username:a.name, totp:a.secret} })) };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a'); link.href = url; link.download = `bitwarden_export.json`; link.click();
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').textContent = msg;
            t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
        }
        function escape(s) { return s ? s.replace(/[&<>"']/g, m => ({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' })[m]) : ''; }
    </script>
</body>
</html>